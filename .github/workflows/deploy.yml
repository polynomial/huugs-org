name: ğŸ–¼ï¸ Process Images & Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'pics/**'
      - 'public/**'
      - 'scripts/**'
      - 'package.json'
      - '.github/workflows/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history for better caching
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        # Install Sharp with specific platform target for better compatibility
        npm rebuild sharp
    
    - name: ğŸ“‹ Check Current Images
      run: |
        echo "ğŸ” Checking pics/ directory structure:"
        find pics/ -type f -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" | head -20
        echo "ğŸ“Š Total image files found: $(find pics/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) | wc -l)"
    
    - name: ğŸ–¼ï¸ Process Images
      run: |
        echo "ğŸš€ Starting image processing..."
        npm run process-images
        echo "âœ… Image processing complete!"
    
    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ“ˆ Build Summary:"
        echo "ğŸ“ Generated galleries: $(ls -la public/images/ | grep ^d | wc -l)"
        echo "ğŸ–¼ï¸ Thumbnail images: $(find public/images/ -name "thumbnails" -type d -exec find {} -name "*.jpg" \; | wc -l)"
        echo "ğŸŒ Web images: $(find public/images/ -name "web" -type d -exec find {} -name "*.jpg" \; | wc -l)"
        echo "ğŸ“„ Configuration files:"
        ls -la public/*.json

    - name: ğŸ§¹ Clean Deployment - Remove Raw Images
      run: |
        echo "ğŸ§¹ Ensuring no raw/original images in deployment..."
        # Remove any original directories that might exist
        find public/images -name "original*" -type d -exec rm -rf {} + || true
        find public/images -name "orig*" -type d -exec rm -rf {} + || true
        echo "ğŸ“Š Final deployment size:"
        du -sh public/
        echo "ğŸ“‚ Deployment contents:"
        find public/images -type d | head -20
        echo "ğŸ¯ Only thumbnails and web versions will be deployed"
    
    - name: ğŸ”§ Setup GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“ Prepare Deployment Package
      run: |
        echo "ğŸ“¦ Preparing deployment files..."
        # Ensure all required files are present
        ls -la public/
        echo "âœ… Deployment package ready"
    
    - name: ğŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public
    
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Successfully deployed to GitHub Pages!"
        echo "ğŸŒ Your photography website is live at: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ  Custom domain: https://huugs.org (after DNS configuration)"






